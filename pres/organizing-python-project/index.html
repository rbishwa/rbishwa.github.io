<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta
		name="viewport"
		content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
	>

	<title>Organizing a Python Project</title>

	<link
		rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/css/reset.min.css"
		integrity="sha256-5/N9vOsEFEeDStOZCuE/rpwRcijUVFx6RY5vjx1usCc="
		crossorigin="anonymous"
	>
	<link
		rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/css/reveal.min.css"
		integrity="sha256-OxiHrn+gXudPDHxTvXiQzeFjZU/FllSSPmOOYAZ1O/g="
		crossorigin="anonymous"
	>
	<link
		rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/css/theme/black.min.css"
		integrity="sha256-FMkhwnY485HRoNNbvFB6F2PHHAfpGSbJQwgGXSCPozM="
		crossorigin="anonymous"
	>

	<!-- Theme used for syntax highlighting of code -->
	<link
		rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/lib/css/monokai.min.css"
		integrity="sha256-uvf9pi6d5ovbhC64Go7y0ayuHYniEGnRBinKQ+ykpDY="
		crossorigin="anonymous"
	>

	<!-- Printing and PDF exports -->
	<script>
		var link = document.createElement("link");
		link.rel = "stylesheet";
		link.type = "text/css";
		link.crossOrigin = "anonymous";
		if ( window.location.search.match(/print-pdf/gi) ) {
			link.href = "https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/css/print/pdf.min.css";
			link.integrity = "sha256-F74eHvgjipGQ87S43T5oVShvlphbiOHS0aljitD4sno=";
		} else {
			link.href = "https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/css/print/paper.min.css";
			link.integrity = "sha256-FuQ6abYf/sPwC97y3FCVaj6VTKRPBX9Szj9wT4rkUvk=";
		}
		document.getElementsByTagName("head")[0].appendChild(link);
	</script>

	<!-- Devicon -->
	<link
		rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/devicon/2.2/devicon.min.css"
		integrity="sha256-4LcvM6Kisp2RIksJbr9MdLdjZrVxALxPqi0SwWmymPI="
		crossorigin="anonymous"
	>

	<!-- Adapt slide style -->
	<link rel="stylesheet" type="text/css" href="main.css">
</head>

<body>
<div class="reveal">
<div class="slides">

<!-- Title slide -->
<section data-background-image="https://source.unsplash.com/xyuYk9oLA8I">
	<h1>
		Organizing a Python Project
	</h1>
	<p><i class="devicon-python-plain"></i></p>
	<h2>
		<div style="font-size: smaller;">
			<p>Antoine Prouvost</p>
			<p>Gerad, Feb 20<sup>th</sup> 2020</p>
		</div>
	</h2>
</section>

<!-- Reminders -->
<section>
	<section data-background-image="https://source.unsplash.com/1H2GCsqG2Hg">
		<h2>Reminders</h2>
	</section>

	<section>
		<h2>RIP Python 2</h2>
		<img class="stretch" alt="Python2 tombstone" data-src="img/python2-dead.png">
	</section>

	<section>
		<h2>Use Git for version Control</h2>
	</section>
</section>

<!-- Scripting example -->
<section>
	<section data-background-image="https://source.unsplash.com/kkaxqEPoF10">
		<h2>Python for scripting</h2>
	</section>

	<section>
		<h2>Python for scripting</h2>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			#!/usr/bin/env python

			import sys

			count = 0
			for line in sys.stdin:
				count += len(line.split())

			print(count)
		</code></pre>
	</section>

	<section>
		<h2>Python for scripting</h2>
		<header class="term-bar">
			<nav style="display: flex; text-align: left;">
				<button style="background-color: rgb(238, 80, 87);"></button>
				<button style="background-color: rgb(222, 198, 18);"></button>
				<button style="background-color: rgb(51, 185, 105);"></button>
			</nav>
			<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%,
				-50%); font-size: 0.58em;">antoine@gerad:~ (bash)</div>
		</header>
		<pre class="term-text stretch"><code data-trim data-noescape class="hljs nohighlight">
			<span class="prompt"></span>echo "Hello world!" | python word_counter.py
			<span class="fragment">2</span>
			<span class="fragment"><span class="prompt"></span>echo "Hello world!" | wc -w</span>
			<span class="fragment">2</span>
		</code></pre>
	</section>

	<section>
		<h2>With multiple files</h2>
		<pre><code data-trim data-noescape>
			counter/
			├── counter.py
			├── word_counter.py
			└── line_counter.py
		</code></pre>
	</section>

	<section>
		<h2>Like this?</h2>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			#!/usr/bin/env python

			import word_counter
		</code></pre>
	</section>

	<section>
		<h2>Or this?</h2>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			#!/usr/bin/env python

			import .word_counter		</code></pre>
	</section>

	<section>
		<h2>Maybe this?</h2>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			#!/usr/bin/env python

			from . import word_counter
		</code></pre>
	</section>

	<section>
		<h2>Just need this?</h2>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			#!/usr/bin/env python

			import sys
			# FIXME: is this current dir or dir of current file?
			sys.path.append(".")

			import word_counter
		</code></pre>
	</section>

	<section>
		<h2>That will do?</h2>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			#!/usr/bin/env python

			import sys
			sys.path.append(__file__)

			import word_counter
		</code></pre>
	</section>

	<section>
		<h2>With an __init__.py?</h2>
		<pre><code data-trim data-noescape>
			counter/
			├── __init__.py
			├── counter.py
			├── word_counter.py
			└── line_counter.py
		</code></pre>
	</section>

	<section data-background-image="https://source.unsplash.com/-2vD8lIhdnw">
		<h2>God Dammit!</h2>
	</section>

	<section>
		<h2>Why does this work?</h2>
		<header class="term-bar">
			<nav style="display: flex; text-align: left;">
				<button style="background-color: rgb(238, 80, 87);"></button>
				<button style="background-color: rgb(222, 198, 18);"></button>
				<button style="background-color: rgb(51, 185, 105);"></button>
			</nav>
			<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%,
				-50%); font-size: 0.58em;">antoine@gerad:~ (bash)</div>
		</header>
		<pre class="term-text stretch"><code data-trim data-noescape class="hljs nohighlight">
			<span class="prompt"></span>ipython
			Python 3.7.5 (default, Oct 25 2019, 10:52:18)

			In [1]:
			<span class="fragment"><span class="prompt"></span>python -m IPython
			Python 3.7.5 (default, Oct 25 2019, 10:52:18)

			In [1]:</span>
			<span class="fragment"><span class="prompt"></span>pip show ipython
			Name: ipython
			Version: 7.12.0
			Summary: IPython: Productive Interactive Computing
			Location: .../miniconda3/lib/python3.7/site-packages
			...
			</span>
		</code></pre>
	</section>
</section>

<!-- Packaging -->
<section>
	<section data-background-image="https://source.unsplash.com/mTkXSSScrzw">
		<h2 style="color: rgb(25,25,25);">Python Packaging</h2>
	</section>

	<section id="package-def">
		<h2>What's a package?</h2>
		<div style="text-align: left;">
			<p>A collection of</p>
			<ul>
				<li>programs &amp; libraries (eventually binary/compiled);</li>
				<li>metadata (version, origin, author, license... );</li>
				<li>other assets (data files...)</li>
			</ul>
			<div class="fragment">
			<p>that is</p>
				<ul>
					<li>relocable (in particular downloadable);</li>
					<li><div class="tooltip">
						self-contained;
						<span class="tooltiptext">
							Contains all of the source, but the package could require third party
							dependencies, best handled by the package manager.
						</span>
						</div></li>
					<li><div class="tooltip">
						directly usable.
						<span class="tooltiptext">
							If the package needs installation, as for source-packages, this is handled
							by the package-manager.
						</span>
					</div></li>
				</ul>
			</div>
		</div>
	</section>

	<section>
		<p>
			<a href="https://packaging.python.org/">PyPA</a> (Python Package Authority), is
			the reference on packaging.
		</p>
		<div class="fragment">
			<p>For example, the packages</p>
			<ul>
				<li><a href="https://numpy.org/">Numpy</a>,</li>
				<li><a href="https://www.scipy.org/">SciPy</a>,</li>
				<li>and <a href="https://ipython.org/">IPython</a></li>
			</ul>
			<p>
				are all available on <a href="https://pypi.org/">PyPI</a> (Python Package Index).
			</p>
		</div>
		<p class="fragment">
			This is what yout get with <code>pip install</code> (by default).
		</p>
	</section>

	<section data-background-image="https://source.unsplash.com/1qQx3LHaYGg">
		<h2 style="color: rgb(25, 25, 25);">Baby's first package</h2>
		<pre><code data-trim data-noescape>
			counter-project/
			├── counter/
			│   ├── __init__.py
			│   ├── word_counter.py
			│   └── line_counter.py
			├── setup.py<span class="fragment">
			├── README.md
			├── LICENSE
			└── .gitignore</span>
		</code></pre>
	</section>

	<section>
		<h2>setup.py</h2>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			from setuptools import setup, find_packages

			setup(
				name="counter",               # Name shown in Pip
				version="0.1.0",
				packages=find_packages(),     # Name of module
				author="Václav Chvátal",
				install_requires=["numpy"],   # Resolved by Pip
				...                           # More information
			)
		</code></pre>
	</section>

	<section data-background-image="https://source.unsplash.com/WPTHZkA-M4I">
		<h2 style="color: white;">Congratulations!</h2>
	</section>

	<section>
		<h2>Installing</h2>
		<pre><code data-trim data-noescape class="hljs nohighlight">
			pip install counter-project/
		</code></pre>
		<pre class="fragment"><code data-trim data-noescape class="hljs nohighlight">
			python -m pip install counter-project/
		</code></pre>
		<pre class="fragment"><code data-trim data-noescape class="hljs nohighlight">
			pip install git+https://github.com/Chvatal/counter-project
		</code></pre>
		<p class="fragment">Making a package does not mean you have to upload it to PyPI.</p>
	</section>

	<section>
		<h2>Using the package</h2>
		<p>
			You can use absolute import anywhere (inside the package code, in a script, test,
			jupyter...)
		</p>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			import counter.line_counter
		</code></pre>
		<div class="fragment">
			<p>
				You can only use relative import inside the package (e.g. in
				<code>word_counter</code>).
			</p>
			<pre><code data-trim data-noescape data-line-numbers class="python">
				from . import line_counter
			</code></pre>
		</div>
		<p class="fragment">Never hack <code>sys.path</code> ever again.</p>
	</section>

	<section>
		<h2>What is happening?</h2>
		<header class="term-bar">
			<nav style="display: flex; text-align: left;">
				<button style="background-color: rgb(238, 80, 87);"></button>
				<button style="background-color: rgb(222, 198, 18);"></button>
				<button style="background-color: rgb(51, 185, 105);"></button>
			</nav>
			<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%,
				-50%); font-size: 0.58em;">antoine@gerad:~ (bash)</div>
		</header>
		<pre class="term-text stretch"><code data-trim data-noescape class="hljs nohighlight">
			<span class="prompt"></span>pwd
			/home/chvatal/counter-project
			<span class="prompt"></span>ls
			counter/  setup.py  README.md  LICENSE
			<span class="fragment"><span class="prompt"></span>pip install .
			...</span>
			<span class="fragment"><span class="prompt"></span>vim counter/word_counter.py
			...</span>
			<span class="fragment"><span class="prompt"></span>ipython
			In [1]: import counter.word_counter

			In [2]:</span>
		</code></pre>
	</section>

	<section>
		<h2>What is happening?</h2>
		<p>The module imported is the local file, not the installed package!</p>
		<p class="fragment">
			Packages are <a href="#/package-def">self-contained</a>.
			Pip made a copy of the counter project code.
		</p>
		<p class="fragment">
			Local files have higher priority.
			The module is imported in a local fashion (no package as in the scripting example).
		</p>
	</section>

	<section>
		<h2>Solutions</h2>
		<ol>
			<li>
				Synchronize package and source code using editable installs.
				<pre><code data-trim data-noescape class="hljs nohighlight">
					pip install --editable counter-project/
				</code></pre>
			</li>
			<li class="fragment">
				Disable local import altogether with the <code>src</code> layout.
				Optional, but recommended for more complex project (e.g. compiled extension).
			</li>
		</ol>
	</section>

	<section>
		<h2>The <code>src</code> layout</h2>
		<p>
			The <code>src</code> layout is
			<a href="https://github.com/pypa/packaging.python.org/issues/320">debated</a>
		</p>
		<p style="font-style: italic;" class="fragment">Is it overkill?</p>
		<p class="fragment">
			Probably for simple projects.
			But for more complex <code>setup.py</code>, it gets relevant to always use the
			package.
		</p>
		<p style="font-style: italic;" class="fragment">Is it hard?</p>
		<p class="fragment">Litterally two lines.</p>
	</section>

	<section>
		<h2>Changes</h2>
		<pre><code data-trim data-noescape>
			counter-project/
			├── src/
			│   └── counter/
			│       ├── __init__.py
			│       ├── word_counter.py
			│       └── line_counter.py
			├── setup.py
			├── README.md
			├── LICENSE
			└── .gitignore
		</code></pre>
		<pre class="fragment"><code data-trim data-noescape data-line-numbers="4-5" class="python">
			from setuptools import setup, find_packages

			setup(
				packages=find_packages(where="src"),
				package_dir={"": "src"},
				...
			)
		</code></pre>
	</section>
</section>

<!-- Tests -->
<section>
	<section data-background-image="https://source.unsplash.com/ViEBSoZH6M4">
		<h2>Testing</h2>
	</section>

	<section>
		<pre><code data-trim data-noescape>
			counter-project/
			├── src/
			│   └── counter/
			│       ├── __init__.py
			│       ├── word_counter.py
			│       └── line_counter.py
			├── test/
			│   └── test_word_counter.py
			├── setup.py
			├── README.md
			├── LICENSE
			└── .gitignore
		</code></pre>
		<p class="fragment">
			Test can be executables, or part of a testing framework (std <code>testing</code>,
			<code>PyTest</code>).
		</p>
	</section>

	<section>
		Thanks to our package project organization, we can
		<pre><code data-trim data-noescape class="python">
			import counter.word_counter
		</code></pre>
		in out tests as easily as
		<pre><code data-trim data-noescape class="python">
			import numpy
		</code></pre>
	</section>

	<section>
		<h2>Standalone test</h2>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			from counter.word_counter import WordCounter


			def test_WordCounter_default():
				counter = WordCounter()
				assert counter("Hello world!\n I am alive!") == 5


			if __name__ == "__main__":
				test_WordCounter_default()
		</code></pre>
		<div class="fragment">
			Run as
			<pre><code data-trim data-noescape class="hljs nohighlight">
				python test/test_word_counter.py
			</code></pre>
		</div>
	</section>

	<section>
		<h2>Meet <a href="https://docs.pytest.org/en/latest/">PyTest</a></h2>
		<p>A test runner</p>
		<ul>
			<li class="fragment">Collect test,</li>
			<li class="fragment">filter (based on name, files...),</li>
			<li class="fragment">report on the test results,</li>
			<li class="fragment">launch debugger on errors...</li>
		</ul>
	</section>

	<section>
		<h2>Meet <a href="https://docs.pytest.org/en/latest/">PyTest</a></h2>
		<p>A test framework, with utility and cutomization</p>
		<ul>
			<li class="fragment">Test for exceptions,</li>
			<li class="fragment">Parametrize test (run with different input data),</li>
			<li class="fragment">Easily reuse complex objects,</li>
			<li class="fragment">
				[custom] Mark test as slow to not run them by default (great for testing algos),
			</li>
			<li class="fragment">
				[plugin] Test timeouts (great for test that may deadlock)...
			</li>
		</ul>
	</section>

	<section>
		<h2>PyTest is easy</h2>
		<p>
			PyTest collects all test as functions starting with <code>test_</code> in all
			python files starting with <code>test_</code>.
		</p>
		<p class="fragment">Use <code>assert</code> to test for anything.</p>
	</section>

	<section>
		<h2>PyTest Example</h2>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			from counter.word_counter import WordCounter


			def test_WordCounter_default():
				counter = WordCounter()
				assert counter("Hello world!\n I am alive!") == 5
		</code></pre>
		<div class="fragment">
			Run as
			<pre><code data-trim data-noescape class="hljs nohighlight">
				python -m pytest test/
			</code></pre>
		</div>
	</section>

	<section>
		<h2>Advanced: Mocking</h2>
		<p>Create fake objects that imitates a class, and record its own usage</p>
		<ul>
			<li class="fragment">Replace complex object with simple ones,</li>
			<li class="fragment">Remove dependencies between tests,</li>
			<li class="fragment">
				Test directly for object usage (funcion calls and parameters), not their
				side effects.
			</li>
		<ul>
		<p class="fragment">
			Available in standard lib
			<code><a href="https://docs.python.org/3/library/unittest.mock.html">
					unitest.mock
			</a></code>
		</p>
	</section>

	<section>
		<h2>Mocking idea</h2>
		<p>
			Complex optimization algorithms with auxillary function for gradient
			descent step (also user implemented).
		</p>
		<p class="fragment">
			Failure in the gradient update leads to errors in the overall algorithm
			(<em>integration test</em>).
		</p>
		<p class="fragment">
			Mocking the gradient update, we can test the algorithm independently
			(<em>unit test</em>).
		</p>
	</section>
</section>

<!-- Executables -->
<section>
	<section data-background-image="https://source.unsplash.com/qjnAnF0jIGk">
		<h2>Executables</h2>
	</section>

	<section>
		<h2>Using scripts</h2>
		<pre><code data-trim data-noescape>
			counter-project/
			├── src/counter/...
			├── test/...
			├── script/
			│   └── word-counter
			├── setup.py
			├── README.md
			├── LICENSE
			└── .gitignore
		</code></pre>
	</section>


	<section>
		<h2><code>word-counter</code> script</h2>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			#!/usr/bin/env python

			import argparse
			import sys

			from counter.word_counter import WordCounter

			# Some command line arguments parsing ...

			counter = WordCounter()
			print(counter(sys.stdin.read()))
		</code></pre>
	</section>

	<section>
		<h2>Shipping with the package</h2>
		<p>Scripts are only visible locally from the source directory.</p>
		<div class="fragment">
			<p>Add them to the package with:</p>
			<pre><code data-trim data-noescape data-line-numbers="6" class="python">
				from setuptools import setup, find_packages

				setup(
					packages=find_packages(where="src"),
					package_dir={"": "src"},
					scripts=["script/word-counter"],
					...
				)
			</code></pre>
		</div>
	</section>

	<section>
		<h2>Usage</h2>
		<p>Anywhere the package is installed, you can run</p>
		<pre><code data-trim data-noescape class="hljs nohighlight">
			echo "Hello word!" | word-counter
		</code></pre>
	</section>

	<section>
		<h2>Executable Modules</h2>
		<p>In the package <code>src/counter/word_counter.py</code>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			...

			def main():
				import argparse
				import sys

				# Some command line arguments parsing ...

				counter = WordCounter()
				print(counter(sys.stdin.read()))

			if __name__ == "__main__":
				main()
		</code></pre>
	</section>

	<section>
		<h2>Usage</h2>
		<p>Anywhere the package is installed, you can run</p>
		<pre><code data-trim data-noescape class="hljs nohighlight">
			echo "Hello word!" | python -m counter.word_counter
		</code></pre>
	</section>

	<section>
		<h2>Or alias a script</h2>
		<pre><code data-trim data-noescape data-line-numbers="6-10" class="python">
			from setuptools import setup, find_packages

			setup(
				packages=find_packages(where="src"),
				package_dir={"": "src"},
				entry_points = {
					"console_scripts": [
						"word-counter=counter.word_counter:main"
					],
				}
				...
			)
		</code></pre>
	</section>

	<section>
		<h2>Usage</h2>
		<p>Anywhere the package is installed, you can run</p>
		<pre><code data-trim data-noescape class="hljs nohighlight">
			echo "Hello word!" | word-counter
		</code></pre>
	</section>

	<section>
		<h2>Pros and Cons</h2>
		<ul>
			<li>Modules don't pollute the shell with executables;</li>
			<li>Modules don't have name conflicts;</li>
			<li>Executalble scripts might get lost in in different environments;</li>
			<li><code>scipts</code> option can ship non python scripts.</li>
		</ul>
	</section>

	<section>
		<h2>Idea</h2>
		Use executable modules for package executable, and keep the <code>script</code>
		directory for developpement scripts.
	</section>

	<section>
		<h2>Bonus: Click</h2>
		If you feel clumsy using
		<a href="https://docs.python.org/3/library/argparse.html"><code>ArgParse</code></a>
		check out
		<a href="https://click.palletsprojects.com/"><code>Click</code></a>.
	</section>
</section>

<!-- Research Code -->
<section>
	<section data-background-image="https://source.unsplash.com/yZygONrUBe8">
		<h2>Research Code</h2>
	</section>

	<section>
		<h2>Library or Application?</h2>
		<dl>
			<dt>Library</dt>
			<dd>Modular code components intended to be reused (e.g. NumPy).</dd>
			<div class="fragment">
				<dt>Application</dt>
				<dd>
					Codebase with no focus other than its own execution (e.g. Jupyter,
					<code>grep</code>, a website).
				</dd>
			</div>
		</dl>
	</section>

	<section>
		<h2>What is Research Code?</h2>
		<ul>
			<li>Some researchers write great libraries (e.g. PyTorch, Scip);</li>
			<li class="fragment">
				Some researchers provide their code as-is without focus on reusability.
			</li>
		</ul>
		<p class="fragment"><em>Both are fine!</em><p>
	</section>

	<section>
		<h2>Motivation for Modular Research</h2>
		<ul>
			<li class="fragment">
				All libraries don't need to be collosal, simplicity is key;
			</li>
			<li class="fragment">You have no obligation to provide support;</li>
			<li class="fragment">
				<span style="font-style: italic;">Copy-to-extend</span> is arduous;
			</li>
			<li class="fragment">Easy access to code moves the field forward;</li>
			<li class="fragment">Easy access to code makes research influencial;</li>
		</ul>
	</section>

	<section>
		<h2>Framework for Modular Research</h2>
		<p>Write modular algorithms in the package</p>
		<ul>
			<li class="fragment">Machine learning models;</li>
			<li class="fragment">Optimization procedures;</li>
			<li class="fragment">Complete algorithms.</li>
		</ul>
		<p class="fragment">As configurable as possible.</p>
		<p class="fragment">No experiment definitions</p>
		<p class="fragment">
			Do not impose any choice, e.g. no filenames or config reading.
		</p>
	</section>

	<section>
		<h2>Framework for Modular Research</h2>
		<p>Write experiements as scripts</p>
		<ul>
			<li class="fragment">All hyperparameters used;</li>
			<li class="fragment">Read files, and configs;</li>
			<li class="fragment">Save and analyse resuts.</li>
		</ul>
		<p class="fragment">
			Use an <code>experiment/</code> folder for experiment scripts.
		</p>
	</section>
</section>

<!-- Compiled Extensions -->
<section>
	<section data-background-image="https://source.unsplash.com/FO7JIlwjOtU">
		<h2>Compiled Extensions</h2>
	</section>

	<section>
		<h2>What's an extension?</h2>
		<p>
			<a href="https://docs.python.org/3/c-api/index.html">CPython</a> is the most
			popular implemntation of the Python interpreter, and is written in <code>C</code>.
		</p>
		<p class="fragment">
			Everything that can be done in Python, can be done in <code>C</code> through the
			library.
		</p>
		<p class="fragment">
			In particular, it is possible to create a Python function that runs arbitrary
			<code>C</code> code.
		</p>
	</section>

	<section>
		<h2>Adding Extension to Packages</h2>
		<pre><code data-trim data-noescape data-line-numbers="3-6,11" class="python">
			from setuptools import setup, find_packages, Extension

			ext = Extension(
				name="counter.fast_word_counter",
				...  # More compiling options
			)

			setup(
				packages=find_packages(where="src"),
				package_dir={"": "src"},
				ext_modules=[ext],
				...
			)
		</code></pre>
		<p>
			Need to reinstall everytime the extension is recompiled (not editable for that
			part).
		</p>
	</section>

	<section>
		<h2><code>Extension</code> Options</h2>
		<pre><code data-trim data-noescape data-line-numbers class="python">
			ext = Extension(
				name="counter.fast_word_counter",
				language="c++",
				sources=...,              # Files to compile
				include_dirs=...,         # -I
				library_dirs=...,         # -L
				runtime_library_dirs=..., # -R
				libraries=...,            # -l
				define_macros=...,        # -D
				...
			)
		</code></pre>
		<p>
			<a href="https://docs.python.org/3/distutils/apiref.html#distutils.core.Extension">
				Full API
			</a>
		</p>
		<p>Python libraries are added automatically.</p>
	</section>

	<section>
		<h2>Cython Extension</h2>
		<p>
			<a href="https://cython.readthedocs.io/en/latest/">Cython</a>
			makes it easy to write compiled extensions without knowing the CPython API.
		</p>
		<p class="fragment">
			<code>.pyx</code> and <code>.pxd</code> can be added directy to
			<code>Extension</code> <code>sources</code> and <code>include_dirs</code> directly.
			<code>cythonize</code> will be called automatically.
		</p>
		<p class="fragment">
			However, Cython needs to be installed.
		</p>
	</section>

	<section>
		<h2>Build Time Dependencies</h2>
		<p>Cython is required to build (compile) the extension but not to run it.</p>
		<pre><code data-trim data-noescape data-line-numbers="12" class="python">
			from setuptools import setup, find_packages, Extension

			ext = Extension(
				name="counter.fast_word_counter",
				...  # More compiling options
			)

			setup(
				packages=find_packages(where="src"),
				package_dir={"": "src"},
				ext_modules=[ext],
				setup_requires=["cython"],
				...
			)
		</code></pre>
	</section>

	<!-- TODO: Add source vs binary packages -->

	<section data-background-image="https://source.unsplash.com/Wfh650C1OHU">
		<h2>Live Example</h2>
	</section>

	<section>
		<h2>PyBind11 Extension</h2>
		<p>
			<a href="https://pybind11.readthedocs.io/en/stable/">PyBind11</a>
			is much more appropriate than Cython to bind C++ code.
		</p>
		<p class="fragment">
			Great for object oriented extensions, and modern C++ (e.g. smart pointers).
		</p>
	</section>
</section>

<!-- Dependencies -->
<section>
	<section data-background-image="https://source.unsplash.com/YLSwjSy7stw">
		<h2>Dependencies</h2>
	</section>

	<section data-background-color="#ffffff">
		<img class="stretch" alt="Fragile dependencies"
			data-src="https://www.monkeyuser.com/assets/images/2018/102-implementation.png">
	</section>

	<section>
		<h2>Library Dependencies</h2>
		<p>General, should be as wide as supported.</p>
		<pre class="fragment"><code data-trim data-noescape data-line-numbers="6" class="python">
			from setuptools import setup, find_packages

			setup(
				packages=find_packages(where="src"),
				package_dir={"": "src"},
				install_requires=["numpy", "scipy>=1.2"]
				...
			)
		</code></pre>
		<p class="fragment">
			Pip will install the dependencies and their recursive dependencies.
		</p>
	</section>

	<section>
		<h2>Application Dependencies</h2>
		<p>Should be as precise as possible (locked) for full reproducability.</p>
		<p class="fragment">Packages API change between versions.</p>
		<p class="fragment">Locking dependencies is complicated. Multiple solutions exists.</p>
	</section>

	<section>
		<h2><code>pip freeze</code></h2>
		<header class="term-bar">
			<nav style="display: flex; text-align: left;">
				<button style="background-color: rgb(238, 80, 87);"></button>
				<button style="background-color: rgb(222, 198, 18);"></button>
				<button style="background-color: rgb(51, 185, 105);"></button>
			</nav>
			<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%,
				-50%); font-size: 0.58em;">antoine@gerad:~ (bash)</div>
		</header>
		<pre class="term-text stretch"><code data-trim data-noescape class="hljs nohighlight">
			<span class="prompt"></span>pip freeze
			numpy==1.18.1
			scipy==1.4.1
			<span class="fragment"><span class="prompt"></span>pip freeze > requirements.txt</span>
			<span class="fragment"><span class="prompt"></span>pip install -r requirements.txt
			...</span>
		</code></pre>
	</section>

	<section>
		<h2><code>pip freeze</code></h2>
		<ul>
			<li>Cumbersome to manage and upgrade</li>
			<li class="fragment">Not perfect locking;</li>
			<li class="fragment">Does not lock non-python dependencies</li>
		</ul>
	</section>

	<section>
		<h2>Use Virtual Environments</h2>
		<p>Isolated Python installations.</p>
		<p class="fragment">Each with installed packages.</p>
		<p class="fragment">
			Disposable if a dependency file (e.g. <code>requirements.txt</code>) is kept
			along.
		</p>
		<p class="fragment">Minimal, avoid versions conflicts.</p>
		<p class="fragment">Ideal to install locked dependencies.</p>
		<p class="fragment">Ideally one per project.</p>
	</section>

	<section>
		<h2>Use Virtual Environments</h2>
		<header class="term-bar">
			<nav style="display: flex; text-align: left;">
				<button style="background-color: rgb(238, 80, 87);"></button>
				<button style="background-color: rgb(222, 198, 18);"></button>
				<button style="background-color: rgb(51, 185, 105);"></button>
			</nav>
			<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%,
				-50%); font-size: 0.58em;">antoine@gerad:~ (bash)</div>
		</header>
		<pre class="term-text stretch"><code data-trim data-noescape class="hljs nohighlight">
			<span class="prompt"></span>python -m venv counter-venv/
			<span class="fragment"><span class="prompt"></span>source counter-venv/bin/activate</span>
			<span class="fragment"><span class="prompt"></span>which pip
			counter-venv/bin/pip</span>
			<span class="fragment"><span class="prompt"></span>pip install .
			...</span>
		</code></pre>
	</section>

	<section>
		<h2>Proper locking</h2>
		<p>
			<a href="pipenv.readthedocs.io/en/latest/">Pipenv</a> is a tool to combine
			virtual environments and <code>pip</code>, with stronger locking mechnisms.
		</p>
		<p class="fragment">
			Unfortunately the future of the project is
			<a href="https://github.com/pypa/pipenv/issues/4058"><em>uncertain</em></a>
		</p>
	</section>

	<section>
		<h2>Library Dependencies &amp; Locking</h2>
		<p>
			Dependencies can be stated in <code>setup.py</code> and additionally locked
			(frozen) for experiment reproducability.
		</p>
		<p class="fragment">
			Having both general and locked dependencies makes it easier to manage &amp; upgrade.
		</p>
	</section>

	<section data-background-image="https://source.unsplash.com/ZhQCZjr9fHo">
		<h2>Live Example</h2>
	</section>
</section>

<!-- Non-Python Dependencies -->
<section>
	<section data-background-image="https://source.unsplash.com/zpbpB4edB70">
		<h2>Non-Python Dependencies</h2>
	</section>

	<section>
		<h2>Example</h2>
		<p>Lot of libraries depends on external libraries (e.g. <code>C</code>).</p>
		<ul class="fragment">
			<li>NumPy: Blas, Lapack, ...</li>
			<li>PyTorch: Blas, Cuda, ...</li>
		</ul>
		<p class="fragment">
			On PyPI (<code>pip</code>), developers do their best to package them.
		</p>
	</section>

	<section>
		<h2>Conda</h2>
		<p>
			<a href="https://docs.conda.io/en/latest/">Conda</a> is a general purpose package
			manager (Python, JavaScript, C/C++, general Linux tooling).
		</p>
			<a href="https://anaconda.org/">Anaconda</a> is Conda with lots of
			pre-downloaded packages.
		<p>
		<p>
			<a href="https://conda-forge.org/">Conda-Forge</a> is a Conda channel with lot
			of open-source projects.
	</section>

	<section>
		<h2>Things you find on Conda</h2>
		<ul>
			<li class="fragment">Python packages;</li>
			<li class="fragment">C/C++/Fortran libraries;</li>
			<li class="fragment">Python;</li>
			<li class="fragment">Julia, R;</li>
			<li class="fragment">Git, CMake, Make, wget, curl, ...</li>
		</ul>
	</section>

	<section>
		<h2>Motivation</h2>
		<ul>
			<li class="fragment">You can choose your Python version</li>
			<li class="fragment">You can get better performances with <code>conda</code>.</li>
			<li class="fragment">
				You get better reproducability:
				<ul>
					<li>Conda resolver is the exact (solves a SAT problem);</li>
					<li>More of your transitive dependencies will be resolved inside Conda.</li>
				</ul>
			</li>
		</ul>
	</section>

	<section>
		<h2>Listing Conda Dependencies</h2>
		<p><a href="https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html#creating-an-environment-file-manually">
				<code>environment_name.yml</code>
			</a></p>
		<pre><code data-trim data-noescape class="hljs nohighlight">
			<span class="fragment">name: environment_name</span>
			<span class="fragment">channels:
				- conda-forge
				- pytorch</span>
			dependencies:
				- python=3.8
				- numpy
		</code></pre>
	</section>

	<section>
		<h2>Usage</h2>
		<pre><code data-trim data-noescape class="hljs nohighlight">
			conda env create --file environment_name.yml
		</code></pre>
		<p>Or for an already exsiting environment</p>
		<pre><code data-trim data-noescape class="hljs nohighlight">
			conda env update --file environment.yml
		</code></pre>
	</section>

	<section>
		<h2>Locking Dependencies</h2>
		<pre><code data-trim data-noescape class="hljs nohighlight">
			conda list > environment_name.txt
		</code></pre>
		<p>Or stronger (OS dependant)</p>
		<pre><code data-trim data-noescape class="hljs nohighlight">
			conda list > environment_name.txt
		</code></pre>
	</section>

	<section>
		<h2>Usage</h2>
		<pre><code data-trim data-noescape class="hljs nohighlight">
			conda create --name environment_name --file environment_name.txt
		</code></pre>
		<p>Or for an already exsiting environment</p>
		<pre><code data-trim data-noescape class="hljs nohighlight">
			conda install --name environment_name --file environment_name.txt
		</code></pre>
	</section>

	<section>
		<h2>Creating Conda package</h2>
		<p class="fragment">
			Is more complicated, and outside the scope of this tutorial.
		</p>
	</section>

	<section>
		<h2>Containers</h2>
		<p style="font-style: italic;">"Light virtual machines"</p>
		<p class="fragment">OS-level reproducability</p>
		<p class="fragment">
			E.g. <a href="https://docs.docker.com/">Docker</a>
			and <a herf="https://sylabs.io/docs/">Singularity</a>.
		</p>
		<p class="fragment" style="font-style: italic;">
			"If all you have is a hammer, everything looks like a nail"
		</p>
	</section>
</section>

<!-- Other Niceties -->
<section>
	<section data-background-image="https://source.unsplash.com/hR545CzxZxk">
		<h2>Other Niceties</h2>
	</section>

	<section>
		<h2>Debugger without IDE</h2>
		<p><a href="https://github.com/gotcha/ipdb">Ipdb</a></p>
	</section>

	<section>
		<h2>Static Analysis</h2>
		<p>
			Using <a href="https://docs.python.org/3/library/typing.html">type hints</a>
			<a href="http://mypy-lang.org/">Mypy</a> can detect inconsistencies without
			running the code.
		</p>
	</section>

	<section>
		<h2>Code formatting</h2>
		<p>
			<a href="https://black.readthedocs.io/en/stable/">Black</a>
			is the uncompromising Python code formatter.
	</section>
</section>

<!-- Questions -->
<section data-background-image="https://source.unsplash.com/lsvw5k9eCZg">
	<h2>Questions?</h2>
	</section>


</div>
</div>

<!-- Load the main reveal.js script -->
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/js/reveal.min.js"
	integrity="sha256-pv4AarTAzSO6lz+bbMPwmV29XMjkzmFOn601b2pWqXE="
	crossorigin="anonymous"
></script>

<script>
	// More info about config & dependencies:
	// - https://github.com/hakimel/reveal.js#configuration
	// - https://github.com/hakimel/reveal.js#dependencies
	function has_markdown() { return !!document.querySelector("[data-markdown]"); }
	Reveal.initialize({
		hash: true,
		slideNumber: "c/t",
		dependencies: [
			{
				src: "https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/plugin/highlight/highlight.min.js",
				callback: function () {
					hljs.configure({tabReplace: "    "});
					hljs.initHighlighting();
				},
				async: true
			},
			{
				src: "https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/plugin/markdown/marked.js",
				condition: has_markdown
			},
			{
				src: "https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/plugin/markdown/markdown.min.js",
				condition: has_markdown
			}
		]
	});
</script>
</body>
</html>
